<div class="model-performance">
  <header class="page-header">
    <h1>Model Performance Analysis</h1>
    <p class="subtitle">Deep dive into quantitative model metrics and trade history</p>
  </header>

  <!-- Card Grid View -->
  @if (viewMode() === 'list') {
    <div class="models-grid">
      @for (model of models(); track model.id) {
        <div class="model-card" (click)="selectModel(model.id)">
          <div class="model-card-header">
            <div class="model-card-title">
              <h3>{{ model.name }}</h3>
              <span class="model-card-strategy">{{ model.strategy }}</span>
            </div>
            <div class="model-card-status" [class.active]="model.status === 'ACTIVE'" [class.paused]="model.status === 'PAUSED'">
              <span class="status-indicator"></span>
              {{ model.status }}
            </div>
          </div>

          <div class="model-card-metrics">
            <div class="model-card-metric primary">
              <span class="metric-label">Total P&L</span>
              <span class="metric-value" [class.positive]="model.totalPnL >= 0" [class.negative]="model.totalPnL < 0">
                {{ formatCurrency(model.totalPnL) }}
              </span>
            </div>

            <div class="model-card-metrics-row">
              <div class="model-card-metric">
                <span class="metric-label">Win Rate</span>
                <span class="metric-value">{{ model.winRate }}%</span>
              </div>
              <div class="model-card-metric">
                <span class="metric-label">Sharpe</span>
                <span class="metric-value">{{ model.sharpeRatio }}</span>
              </div>
              <div class="model-card-metric">
                <span class="metric-label">Trades</span>
                <span class="metric-value">{{ model.totalTrades }}</span>
              </div>
            </div>
          </div>

          <div class="model-card-footer">
            <span class="view-details">View Details →</span>
          </div>
        </div>
      }
    </div>
  }

  <!-- Detail View -->
  @if (viewMode() === 'detail' && selectedModel(); as model) {
    <div class="model-detail-view">
      <button class="back-button" (click)="backToList()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
        Back to Models
      </button>
      <div class="model-details">
        <!-- Model Info Header -->
        <div class="model-info-card">
          <div class="model-title-section">
            <div>
              <h2>{{ model.name }}</h2>
              <p class="strategy-type">{{ model.strategy }}</p>
            </div>
            <div class="model-status" [class.active]="model.status === 'ACTIVE'">
              <span class="status-indicator"></span>
              {{ model.status }}
            </div>
          </div>

          <!-- Key Metrics Grid -->
          <div class="key-metrics-grid">
            <div class="key-metric">
              <div class="metric-icon profit">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                </svg>
              </div>
              <div class="metric-info">
                <span class="metric-label">Total Profit</span>
                <span class="metric-value positive">{{ formatCurrency(model.totalPnL) }}</span>
              </div>
            </div>

            <div class="key-metric">
              <div class="metric-icon accuracy">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
              </div>
              <div class="metric-info">
                <span class="metric-label">Win Rate</span>
                <span class="metric-value">{{ model.winRate }}%</span>
              </div>
            </div>

            <div class="key-metric">
              <div class="metric-icon risk">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                  <path d="M16 18l-2.29-2.29 4.88-4.88 4 4L22 7.41 20.59 6l-6 6-4-4-6.3 6.29L2 12v6z" opacity="0.5"/>
                </svg>
              </div>
              <div class="metric-info">
                <span class="metric-label">Sharpe Ratio</span>
                <span class="metric-value">{{ model.sharpeRatio }}</span>
              </div>
            </div>

            <div class="key-metric">
              <div class="metric-icon drawdown">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"/>
                </svg>
              </div>
              <div class="metric-info">
                <span class="metric-label">Max Drawdown</span>
                <span class="metric-value negative">{{ model.maxDrawdown }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Metrics -->
        <div class="advanced-metrics">
          <h3>Advanced Metrics</h3>
          <div class="metrics-grid">
            <div class="metric-card">
              <span class="metric-label">Total Trades</span>
              <span class="metric-value">{{ model.totalTrades }}</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">Average Win</span>
              <span class="metric-value positive">{{ formatCurrency(model.avgWin) }}</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">Average Loss</span>
              <span class="metric-value negative">{{ formatCurrency(model.avgLoss) }}</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">Win/Loss Ratio</span>
              <span class="metric-value">{{ getWinLossRatio(model) }}</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">Expectancy</span>
              <span class="metric-value positive">{{ formatCurrency(getExpectancy(model)) }}</span>
            </div>
            <div class="metric-card">
              <span class="metric-label">Profit Factor</span>
              <span class="metric-value">{{ getProfitFactor(model).toFixed(2) }}</span>
            </div>
          </div>
        </div>

        <!-- Trade History -->
        <div class="trade-history">
          <div class="trade-history-header">
            <h3>Trade History</h3>
            <a 
              [routerLink]="getViewAllTradesLink()" 
              [queryParams]="getViewAllTradesQueryParams()"
              class="view-all-link">
              View All Trades →
            </a>
          </div>
          <!-- Desktop Table View -->
          <div class="trades-table-container">
            <table class="trades-table">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Quantity</th>
                  <th>Entry Price</th>
                  <th>Current Price</th>
                  <th>P&L</th>
                  <th>P&L %</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                @for (trade of modelTrades(); track trade.id) {
                  <tr>
                    <td class="symbol">
                      {{ getTradeDisplaySymbol(trade) }}
                    </td>
                    <td>
                      @for (tag of getTradeTags(trade); track tag) {
                        @if (tag === 'COMPOUND') {
                          <span class="side-badge compound">COMPOUND</span>
                        } @else if (tag === 'BUY' || tag === 'SELL') {
                          <span class="side-badge" [class.buy]="tag === 'BUY'" [class.sell]="tag === 'SELL'">
                            {{ tag }}
                          </span>
                        } @else if (tag === 'PAPER') {
                          <span class="paper-badge">Paper</span>
                        }
                      }
                    </td>
                    <td>
                      @if (trade.positions.length > 1) {
                        {{ trade.positions.length }} pos
                      } @else {
                        {{ getPrimaryPosition(trade).quantity }}
                      }
                    </td>
                    <td>{{ formatCurrency(getPrimaryPosition(trade).entryPrice) }}</td>
                    <td>{{ formatCurrency(getPrimaryPosition(trade).currentPrice) }}</td>
                    <td [class.positive]="trade.pnl >= 0" [class.negative]="trade.pnl < 0">
                      {{ formatCurrency(trade.pnl) }}
                    </td>
                    <td [class.positive]="trade.pnlPercent >= 0" [class.negative]="trade.pnlPercent < 0">
                      {{ formatPercent(trade.pnlPercent) }}
                    </td>
                    <td>
                      <span class="status-badge" [class.open]="trade.status === 'OPEN'" 
                            [class.closed]="trade.status === 'CLOSED'">
                        {{ trade.status }}
                      </span>
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td colspan="8" class="no-trades">No trades for this model</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Mobile Card View -->
          <div class="trades-cards-container">
            @for (trade of modelTrades(); track trade.id) {
              <div class="trade-card">
                <div class="trade-card-header">
                  <div class="trade-card-symbol">
                    {{ getTradeDisplaySymbol(trade) }}
                  </div>
                  <div class="trade-card-badges">
                    @for (tag of getTradeTags(trade); track tag) {
                      @if (tag === 'COMPOUND') {
                        <span class="side-badge compound">COMPOUND</span>
                      } @else if (tag === 'BUY' || tag === 'SELL') {
                        <span class="side-badge" [class.buy]="tag === 'BUY'" [class.sell]="tag === 'SELL'">
                          {{ tag }}
                        </span>
                      } @else if (tag === 'PAPER') {
                        <span class="paper-badge">Paper</span>
                      }
                    }
                    <span class="status-badge" [class.open]="trade.status === 'OPEN'" 
                          [class.closed]="trade.status === 'CLOSED'">
                      {{ trade.status }}
                    </span>
                  </div>
                </div>
                <div class="trade-card-body">
                  <div class="trade-card-row">
                    <span class="trade-card-label">Quantity:</span>
                    <span class="trade-card-value">
                      @if (trade.positions.length > 1) {
                        {{ trade.positions.length }} positions
                      } @else {
                        {{ getPrimaryPosition(trade).quantity }}
                      }
                    </span>
                  </div>
                  <div class="trade-card-row">
                    <span class="trade-card-label">Entry Price:</span>
                    <span class="trade-card-value">{{ formatCurrency(getPrimaryPosition(trade).entryPrice) }}</span>
                  </div>
                  <div class="trade-card-row">
                    <span class="trade-card-label">Current Price:</span>
                    <span class="trade-card-value">{{ formatCurrency(getPrimaryPosition(trade).currentPrice) }}</span>
                  </div>
                </div>
                <div class="trade-card-footer">
                  <div class="trade-card-pnl">
                    <span class="trade-card-label">P&L:</span>
                    <span class="trade-card-value" [class.positive]="trade.pnl >= 0" [class.negative]="trade.pnl < 0">
                      {{ formatCurrency(trade.pnl) }}
                    </span>
                  </div>
                  <div class="trade-card-pnl-percent" [class.positive]="trade.pnlPercent >= 0" [class.negative]="trade.pnlPercent < 0">
                    {{ formatPercent(trade.pnlPercent) }}
                  </div>
                </div>
              </div>
            } @empty {
              <div class="no-trades-card">No trades for this model</div>
            }
          </div>
          
          <!-- Pagination Controls -->
          @if (totalPages() > 1) {
            <div class="pagination">
              <button 
                class="page-btn"
                [disabled]="currentPage() === 1"
                (click)="previousPage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
              </button>

              @for (page of pageNumbers; track page) {
                @if (page === -1) {
                  <span class="page-ellipsis">...</span>
                } @else {
                  <button 
                    class="page-btn"
                    [class.active]="currentPage() === page"
                    (click)="goToPage(page)">
                    {{ page }}
                  </button>
                }
              }

              <button 
                class="page-btn"
                [disabled]="currentPage() === totalPages()"
                (click)="nextPage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
              </button>
            </div>
          }
          
          <div class="pagination-info">
            Showing {{ modelTrades().length }} of {{ allModelTrades().length }} trades
          </div>
        </div>
      </div>
    </div>
  }
</div>

