<div class="live-trades">
  <header class="page-header">
    <h1>Live Trades Monitor</h1>
    <p class="subtitle">Real-time monitoring of active positions and trade execution</p>
  </header>

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="filters-container">
      <div class="filter-group">
        <label class="filter-label">Search Symbol</label>
        <input 
          type="text" 
          class="filter-input"
          placeholder="e.g., AAPL"
          [value]="searchTerm()"
          (input)="onSearchChange($any($event.target).value)">
      </div>

      <div class="filter-group">
        <label class="filter-label">From Date</label>
        <input 
          type="date" 
          class="filter-input"
          [value]="formatDateForInput(startDate())"
          (change)="onStartDateChange($any($event.target).value)">
      </div>

      <div class="filter-group">
        <label class="filter-label">To Date</label>
        <input 
          type="date" 
          class="filter-input"
          [value]="formatDateForInput(endDate())"
          (change)="onEndDateChange($any($event.target).value)">
      </div>

      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select 
          class="filter-select"
          [value]="filterStatus()"
          (change)="onFilterStatusChange($any($event.target).value)">
          <option value="ALL">All</option>
          <option value="OPEN">Open</option>
          <option value="CLOSED">Closed</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Side</label>
        <select 
          class="filter-select"
          [value]="filterSide()"
          (change)="onFilterSideChange($any($event.target).value)">
          <option value="ALL">All</option>
          <option value="BUY">Buy</option>
          <option value="SELL">Sell</option>
          <option value="COMPOUND">Compound</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">Model</label>
        <select 
          class="filter-select"
          [value]="filterModel()"
          (change)="onFilterModelChange($any($event.target).value)">
          <option value="ALL">All Models</option>
          @for (model of models(); track model.id) {
            <option [value]="model.id">{{ model.name }}</option>
          }
        </select>
      </div>

      <button class="clear-filters-btn" (click)="clearFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
        Clear
      </button>
    </div>

    <div class="filter-results">
      Showing {{ paginatedTrades().length }} of {{ filteredTrades().length }} trades (Open positions always shown)
    </div>
  </div>

  <!-- Master-Detail Layout -->
  <div class="master-detail-container">
    <!-- Trade List (Left Pane) -->
    <div class="trade-list" [class.hidden-mobile]="selectedTrade() !== null">
      
      <div class="trade-list-items">
        @for (trade of allTradesForList(); track trade.id) {
          <div 
            class="trade-list-item"
            [class.active]="isTradeSelected(trade)"
            [class.closed]="trade.status === 'CLOSED'"
            (click)="selectTrade(trade)">
            <div class="trade-list-item-header">
              <div class="trade-symbol">
                {{ getTradeDisplaySymbol(trade) }}
              </div>
              @if (isCompoundTrade(trade)) {
                <span class="side-badge small compound">COMPOUND</span>
              } @else {
                <span class="side-badge small" [class.buy]="getPrimaryPosition(trade).side === 'BUY'" 
                      [class.sell]="getPrimaryPosition(trade).side === 'SELL'">
                  {{ getPrimaryPosition(trade).side }}
                </span>
              }
            </div>
            <div class="trade-list-item-body">
              <div class="trade-model-name">{{ getModelName(trade.modelId) }}</div>
              <div class="trade-pnl" [class.positive]="trade.pnl >= 0" [class.negative]="trade.pnl < 0">
                {{ formatCurrency(trade.pnl) }}
              </div>
            </div>
            <div class="trade-list-item-footer">
              <span class="trade-time">{{ formatTime(trade.timestamp) }}</span>
              @if (trade.status === 'OPEN') {
                <span class="status-indicator open">LIVE</span>
              } @else {
                <span class="status-indicator closed">CLOSED</span>
              }
            </div>
          </div>
        } @empty {
          <div class="empty-list">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
            </svg>
            <p>No trades available</p>
          </div>
        }
      </div>

      <!-- Pagination Controls -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <button 
            class="page-btn"
            [disabled]="currentPage() === 1"
            (click)="previousPage()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
          </button>

          @for (page of pageNumbers; track page) {
            @if (page === -1) {
              <span class="page-ellipsis">...</span>
            } @else {
              <button 
                class="page-btn"
                [class.active]="currentPage() === page"
                (click)="goToPage(page)">
                {{ page }}
              </button>
            }
          }

          <button 
            class="page-btn"
            [disabled]="currentPage() === totalPages()"
            (click)="nextPage()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
            </svg>
          </button>
        </div>
      }
    </div>

    <!-- Trade Detail (Right Pane) -->
    @if (selectedTrade(); as trade) {
      <div class="trade-detail visible-mobile">
        <button class="mobile-back-btn" (click)="goBackToList()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
          </svg>
          Back to List
        </button>
        <div class="trade-detail-header">
          <div class="detail-header-left">
            <h2 class="detail-symbol">
              {{ getTradeDisplaySymbol(trade) }}
            </h2>
            @if (isCompoundTrade(trade)) {
              <span class="side-badge large compound">COMPOUND</span>
            } @else {
              <span class="side-badge large" [class.buy]="getPrimaryPosition(trade).side === 'BUY'" 
                    [class.sell]="getPrimaryPosition(trade).side === 'SELL'">
                {{ getPrimaryPosition(trade).side }}
              </span>
            }
            @if (trade.status === 'OPEN') {
              <span class="live-badge">LIVE</span>
            } @else {
              <span class="closed-badge">CLOSED</span>
            }
          </div>
          <div class="detail-header-right">
            <div class="detail-pnl" [class.positive]="trade.pnl >= 0" [class.negative]="trade.pnl < 0">
              <div class="pnl-amount">{{ formatCurrency(trade.pnl) }}</div>
              <div class="pnl-percent">{{ formatPercent(trade.pnlPercent) }}</div>
            </div>
          </div>
        </div>

        <div class="detail-sections">
          <!-- Positions Section (for compound trades) -->
          @if (isCompoundTrade(trade)) {
            <section class="detail-section positions-section">
              <h3 class="section-title">Positions</h3>
              <div class="positions-table-container">
                <table class="positions-table">
                  <thead>
                    <tr>
                      <th>Pair</th>
                      <th>Side</th>
                      <th>Quantity</th>
                      <th>Entry Price</th>
                      <th>Current Price</th>
                      <th>P&L</th>
                      <th>P&L %</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (position of trade.positions; track position.id) {
                      <tr>
                        <td class="position-pair-cell">
                          <span class="position-from">{{ position.fromAsset }}</span>
                          <span class="position-arrow">â†’</span>
                          <span class="position-to">{{ position.toAsset }}</span>
                        </td>
                        <td>
                          <span class="side-badge small" [class.buy]="position.side === 'BUY'" 
                                [class.sell]="position.side === 'SELL'">
                            {{ position.side }}
                          </span>
                        </td>
                        <td>{{ position.quantity }}</td>
                        <td>{{ formatCurrency(position.entryPrice) }}</td>
                        <td>{{ formatCurrency(position.currentPrice) }}</td>
                        <td [class.positive]="position.pnl >= 0" [class.negative]="position.pnl < 0">
                          {{ formatCurrency(position.pnl) }}
                        </td>
                        <td [class.positive]="position.pnlPercent >= 0" [class.negative]="position.pnlPercent < 0">
                          {{ formatPercent(position.pnlPercent) }}
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </section>
          }

          <!-- Metrics and Conditions (Priority Section) -->
          <section class="detail-section metrics-section">
            <app-trade-metrics [metrics]="tradeMetrics()"></app-trade-metrics>
          </section>

          <!-- Model Parameters -->
          @if (modelParameters(); as params) {
            <section class="detail-section">
              <h3 class="section-title">Model Parameters</h3>
              <div class="parameters-grid">
                @for (param of params.parameters; track param.name) {
                  <div class="parameter-card">
                    <div class="parameter-header">
                      <span class="parameter-name">{{ param.name }}</span>
                      @if (param.description) {
                        <span class="parameter-description">{{ param.description }}</span>
                      }
                    </div>
                    <div class="parameter-value">
                      @if (typeof param.value === 'number') {
                        @if (param.unit === '$') {
                          <span class="value-number">{{ formatCurrency(param.value) }}</span>
                        } @else {
                          <span class="value-number">{{ param.value.toFixed(4) }}</span>
                          @if (param.unit) {
                            <span class="value-unit">{{ param.unit }}</span>
                          }
                        }
                      } @else {
                        <span class="value-text">{{ param.value }}</span>
                      }
                    </div>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Performance Metrics -->
          <section class="detail-section">
            <h3 class="section-title">Performance Metrics</h3>
            <div class="metrics-cards">
              <div class="metric-card" [class.positive]="trade.pnl >= 0" [class.negative]="trade.pnl < 0">
                <div class="metric-card-label">Profit & Loss</div>
                <div class="metric-card-value">{{ formatCurrency(trade.pnl) }}</div>
                <div class="metric-card-subtitle">{{ formatPercent(trade.pnlPercent) }}</div>
              </div>
              <div class="metric-card">
                <div class="metric-card-label">Position Value</div>
                @if (isCompoundTrade(trade)) {
                  <div class="metric-card-value">{{ formatCurrency(getTotalPositionValue(trade)) }}</div>
                  <div class="metric-card-subtitle">{{ trade.positions.length }} position(s)</div>
                } @else {
                  @if (getPrimaryPosition(trade); as pos) {
                    <div class="metric-card-value">{{ formatCurrency(pos.currentPrice * pos.quantity) }}</div>
                    <div class="metric-card-subtitle">{{ pos.quantity }} shares</div>
                  }
                }
              </div>
              <div class="metric-card">
                <div class="metric-card-label">Cost Basis</div>
                @if (isCompoundTrade(trade)) {
                  <div class="metric-card-value">{{ formatCurrency(getTotalCostBasis(trade)) }}</div>
                  <div class="metric-card-subtitle">Initial investment</div>
                } @else {
                  @if (getPrimaryPosition(trade); as pos) {
                    <div class="metric-card-value">{{ formatCurrency(pos.entryPrice * pos.quantity) }}</div>
                    <div class="metric-card-subtitle">Initial investment</div>
                  }
                }
              </div>
            </div>
          </section>

          <!-- Trade Information -->
          <section class="detail-section">
            <h3 class="section-title">Trade Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Model</span>
                <span class="detail-value">{{ getModelName(trade.modelId) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Status</span>
                <span class="detail-value">{{ trade.status }}</span>
              </div>
              @if (!isCompoundTrade(trade)) {
                @if (getPrimaryPosition(trade); as pos) {
                  <div class="detail-item">
                    <span class="detail-label">Quantity</span>
                    <span class="detail-value">{{ pos.quantity }}</span>
                  </div>
                }
              } @else {
                <div class="detail-item">
                  <span class="detail-label">Positions</span>
                  <span class="detail-value">{{ trade.positions.length }}</span>
                </div>
              }
              <div class="detail-item">
                <span class="detail-label">Entry Time</span>
                <span class="detail-value">{{ formatDate(trade.timestamp) }}</span>
              </div>
            </div>
          </section>

          <!-- Price Information -->
          @if (!isCompoundTrade(trade)) {
            <section class="detail-section">
              <h3 class="section-title">Price Information</h3>
              @if (getPrimaryPosition(trade); as pos) {
                <div class="detail-grid">
                  <div class="detail-item">
                    <span class="detail-label">Entry Price</span>
                    <span class="detail-value highlight">{{ formatCurrency(pos.entryPrice) }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Current Price</span>
                    <span class="detail-value highlight current-price">{{ formatCurrency(pos.currentPrice) }}</span>
                  </div>
                  @if (pos.exitPrice) {
                    <div class="detail-item">
                      <span class="detail-label">Exit Price</span>
                      <span class="detail-value highlight">{{ formatCurrency(pos.exitPrice) }}</span>
                    </div>
                  }
                  <div class="detail-item">
                    <span class="detail-label">Price Change</span>
                    <span class="detail-value" [class.positive]="pos.currentPrice >= pos.entryPrice" 
                          [class.negative]="pos.currentPrice < pos.entryPrice">
                      {{ formatCurrency(pos.currentPrice - pos.entryPrice) }}
                    </span>
                  </div>
                </div>
              }
            </section>
          }
        </div>
      </div>
    } @else {
      <div class="trade-detail trade-detail-empty hidden-mobile">
        <div class="empty-detail">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
          </svg>
          <h3>No Trade Selected</h3>
          <p>Select a trade from the list to view details</p>
        </div>
      </div>
    }
  </div>
</div>
